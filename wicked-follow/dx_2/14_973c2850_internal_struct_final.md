# 커밋 #14: 973c2850 - Made some internal structures final

## 기본 정보

| 항목 | 내용 |
|------|------|
| 커밋 해시 | `973c2850` |
| 날짜 | 2025-11-26 |
| 작성자 | Turánszki János |
| 카테고리 | 최적화 |
| 우선순위 | 낮음 |

## 변경 파일 요약

| 파일 | 변경 |
|------|------|
| wiGraphicsDevice_DX12.cpp | `Texture_DX12`, `BVH_DX12`에 `final` 키워드 추가 |

---

## 배경 지식: final 키워드

### final의 두 가지 용도

```cpp
// 1. 클래스 상속 금지
struct Texture_DX12 final : public Resource_DX12 {
    // 이 클래스를 상속할 수 없음
};

// 2. 가상 함수 오버라이드 금지
struct Base {
    virtual void foo() final;  // 파생 클래스에서 오버라이드 불가
};
```

### Devirtualization (역가상화)

```
┌─────────────────────────────────────────────────────────────────┐
│              final과 Devirtualization                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  일반 가상 함수 호출:                                           │
│  ─────────────────────                                          │
│  Resource_DX12* ptr = getResource();                            │
│  ptr->someVirtualMethod();                                      │
│                                                                 │
│  컴파일러:                                                      │
│  1. vtable 포인터 로드                                          │
│  2. vtable에서 함수 주소 찾기                                   │
│  3. 간접 호출 (indirect call)                                   │
│                                                                 │
│  → 분기 예측 어려움, 인라이닝 불가                              │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  final 클래스의 가상 함수 호출:                                 │
│  ─────────────────────────────                                  │
│  Texture_DX12* ptr = getTexture();  // final 클래스             │
│  ptr->someVirtualMethod();                                      │
│                                                                 │
│  컴파일러:                                                      │
│  "Texture_DX12는 final이므로 더 이상 파생 클래스 없음"          │
│  "정확한 타입을 알 수 있으므로 직접 호출 가능"                  │
│                                                                 │
│  1. 직접 호출 (direct call)                                     │
│  2. 인라이닝 가능!                                              │
│                                                                 │
│  → 분기 예측 필요 없음, 인라이닝으로 추가 최적화                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 성능 영향

```
┌─────────────────────────────────────────────────────────────────┐
│              가상 함수 호출 비용                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  간접 호출 (virtual):                                           │
│  - vtable 로드: ~3-5 cycles                                     │
│  - 간접 점프: ~10-20 cycles (분기 예측 실패 시 더 김)           │
│  - 인라이닝 불가: 추가 최적화 기회 상실                         │
│                                                                 │
│  직접 호출 (devirtualized):                                     │
│  - 직접 점프: ~1-3 cycles                                       │
│  - 인라이닝 가능: 함수 호출 오버헤드 제거                       │
│                                                                 │
│  개별 호출 차이: 미미함                                         │
│  BUT: 그래픽스에서 수만 번 호출 시 누적 효과                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 변경 내용

### DX12 Internal Structures

```cpp
// 변경 전
struct Texture_DX12 : public Resource_DX12
{
    // ...
};

struct BVH_DX12 : public Resource_DX12
{
    // ...
};

// 변경 후
struct Texture_DX12 final : public Resource_DX12
{
    // ...
};

struct BVH_DX12 final : public Resource_DX12
{
    // ...
};
```

### 왜 이 두 클래스만?

```
┌─────────────────────────────────────────────────────────────────┐
│              final 추가 대상 선정 기준                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Resource_DX12 계층 구조:                                       │
│                                                                 │
│  Resource_DX12 (base)                                           │
│       ├── Texture_DX12 final    ← 더 이상 파생 없음             │
│       └── BVH_DX12 final        ← 더 이상 파생 없음             │
│                                                                 │
│  이 클래스들은:                                                 │
│  1. 내부 구현 클래스 (외부 API 아님)                            │
│  2. 더 이상 상속할 계획 없음                                    │
│  3. 자주 사용됨 (성능 최적화 의미 있음)                         │
│                                                                 │
│  참고: 커밋 #7에서 GPUBuffer, Texture 등 public 클래스도        │
│       final로 선언됨                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 비유: 택배 배송

```
┌─────────────────────────────────────────────────────────────────┐
│                    택배 비유                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  가상 함수 호출 (final 없음):                                   │
│  ─────────────────────────────                                  │
│  "이 주소로 배송해주세요"                                       │
│  → 주소록에서 실제 주소 찾기 (vtable lookup)                    │
│  → 찾은 주소로 이동 (indirect jump)                             │
│                                                                 │
│  직접 호출 (final 있음):                                        │
│  ─────────────────────────                                      │
│  "여기가 최종 목적지입니다" (final)                             │
│  → 바로 이동 (direct jump)                                      │
│  → 주소록 찾을 필요 없음                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## VizMotive 적용 현황

### 적용 완료 ✅

**적용 일자**: 2026-01-28

| 파일 | 변경 내용 |
|------|----------|
| GraphicsDevice_DX12.cpp | `struct Texture_DX12 final : public Resource_DX12` |
| GraphicsDevice_DX12.cpp | `struct BVH_DX12 final : public Resource_DX12` |

### 참고

커밋 #20에서 `Texture_DX12`가 `Resource_DX12`에 병합되어 삭제됨.
현재 VizMotive에서는 `BVH_DX12 final`만 유효함.

---

## 요약

| 항목 | 내용 |
|------|------|
| 변경 | `Texture_DX12`, `BVH_DX12`에 `final` 키워드 추가 |
| 목적 | 컴파일러 devirtualization 최적화 활성화 |
| 효과 | 가상 함수 직접 호출 + 인라이닝 가능 |
| VizMotive | ✅ 적용 완료 |

### 핵심 교훈

> **더 이상 상속하지 않을 클래스는 final로 선언**
>
> - 컴파일러가 devirtualization 수행 가능
> - 가상 함수 호출 오버헤드 제거
> - 인라이닝 기회 증가
> - 의도 명확화 (이 클래스는 상속 안 함)
