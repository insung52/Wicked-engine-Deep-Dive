# ì»¤ë°‹ #9: e1dc87e4 - Prevent calling destructor when original refcount was 0

## ê¸°ë³¸ ì •ë³´

| í•­ëª© | ë‚´ìš© |
|------|------|
| ì»¤ë°‹ í•´ì‹œ | `e1dc87e4` |
| ë‚ ì§œ | 2025-11-23 |
| ì‘ì„±ì | TurÃ¡nszki JÃ¡nos |
| ì¹´í…Œê³ ë¦¬ | ë²„ê·¸ìˆ˜ì • / ì•ˆì •ì„± |
| ìš°ì„ ìˆœìœ„ | ë†’ìŒ |

## ë³€ê²½ íŒŒì¼ ìš”ì•½

| íŒŒì¼ | ë³€ê²½ |
|------|------|
| wiAllocator.h | `dec_refcount`ì— `destruct_on_zero` íŒŒë¼ë¯¸í„° ì¶”ê°€ |

---

## ë°°ê²½ ì§€ì‹: weak_ptr::lock() ë™ì‘

### weak_ptrì˜ ëª©ì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 shared_ptr vs weak_ptr                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  shared_ptr:                                                    â”‚
â”‚  - ê°ì²´ì˜ "ì†Œìœ ê¶Œ"ì„ ê°€ì§                                       â”‚
â”‚  - refcount > 0ì¸ ë™ì•ˆ ê°ì²´ ìœ ì§€                                â”‚
â”‚  - ëª¨ë“  shared_ptr ì†Œë©¸ ì‹œ ê°ì²´ íŒŒê´´                            â”‚
â”‚                                                                 â”‚
â”‚  weak_ptr:                                                      â”‚
â”‚  - ê°ì²´ë¥¼ "ê´€ì°°"ë§Œ í•¨ (ì†Œìœ í•˜ì§€ ì•ŠìŒ)                           â”‚
â”‚  - ê°ì²´ ìˆ˜ëª…ì— ì˜í–¥ ì—†ìŒ                                        â”‚
â”‚  - lock()ìœ¼ë¡œ shared_ptr ì–»ì–´ì„œ ì‚¬ìš©                            â”‚
â”‚  - ê°ì²´ê°€ ì´ë¯¸ íŒŒê´´ëìœ¼ë©´ lock() ì‹¤íŒ¨                           â”‚
â”‚                                                                 â”‚
â”‚  ì‚¬ìš© ì‚¬ë¡€:                                                     â”‚
â”‚  - ìˆœí™˜ ì°¸ì¡° ë°©ì§€                                               â”‚
â”‚  - ìºì‹œ (ê°ì²´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±)                  â”‚
â”‚  - ê´€ì°°ì íŒ¨í„´                                                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### lock() í•¨ìˆ˜ì˜ ì—­í• 

```cpp
// weak_ptr::lock()ì˜ ëª©ì 
// - weak_ptrì´ ê°€ë¦¬í‚¤ëŠ” ê°ì²´ê°€ ì•„ì§ ì‚´ì•„ìˆìœ¼ë©´ shared_ptr ë°˜í™˜
// - ê°ì²´ê°€ ì´ë¯¸ íŒŒê´´ëìœ¼ë©´ ë¹ˆ shared_ptr ë°˜í™˜

weak_ptr<Texture_DX12> weak = ...;

shared_ptr<Texture_DX12> strong = weak.lock();
if (strong.IsValid())
{
    // ê°ì²´ ì‚¬ìš© ê°€ëŠ¥
    strong->DoSomething();
}
else
{
    // ê°ì²´ ì´ë¯¸ íŒŒê´´ë¨
}
```

---

## ë¬¸ì œ ìƒí™©

### ì»¤ë°‹ #8ì˜ lock() êµ¬í˜„ (ë²„ê·¸ ìˆìŒ)

```cpp
shared_ptr<T> lock()
{
    if (!ptr || !allocator) return {};

    // 1. refcount ì¦ê°€
    uint32_t old_strong = allocator->inc_refcount(ptr);

    // 2. ì›ë˜ refcountê°€ 0ì´ì—ˆë‹¤ë©´ (ê°ì²´ ì´ë¯¸ íŒŒê´´ë¨)
    if (old_strong == 0)
    {
        // 3. refcount ì›ë³µ (1 â†’ 0)
        allocator->dec_refcount(ptr);  // âš ï¸ ì—¬ê¸°ì„œ ë¬¸ì œ!
        return {};
    }

    // ì„±ê³µ: shared_ptr ë°˜í™˜
    shared_ptr<T> ret;
    ret.ptr = ptr;
    ret.allocator = allocator;
    return ret;
}
```

### ë²„ê·¸ ë¶„ì„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì´ì¤‘ ì†Œë©¸ì í˜¸ì¶œ ë²„ê·¸                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ì‹œë‚˜ë¦¬ì˜¤:                                                      â”‚
â”‚  1. Texture_DX12 ê°ì²´ ìƒì„±, refcount = 1                        â”‚
â”‚  2. weak_ptr ìƒì„±, weak_refcount = 1                            â”‚
â”‚  3. ë§ˆì§€ë§‰ shared_ptr ì†Œë©¸ â†’ refcount 0 â†’ ì†Œë©¸ì í˜¸ì¶œ â‘         â”‚
â”‚  4. weak_ptr::lock() í˜¸ì¶œ                                       â”‚
â”‚                                                                 â”‚
â”‚  lock() ë‚´ë¶€:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: inc_refcount(ptr)                                â”‚   â”‚
â”‚  â”‚         refcount: 0 â†’ 1                                  â”‚   â”‚
â”‚  â”‚         ë°˜í™˜ê°’: 0 (ì´ì „ ê°’)                              â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ Step 2: old_strong == 0 ì´ë¯€ë¡œ ì¡°ê±´ ì°¸                   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ Step 3: dec_refcount(ptr)                                â”‚   â”‚
â”‚  â”‚         refcount: 1 â†’ 0                                  â”‚   â”‚
â”‚  â”‚         if (old == 1) â†’ ì†Œë©¸ì í˜¸ì¶œ â‘¡  â† ğŸ’¥ ì´ì¤‘ í˜¸ì¶œ!  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ê²°ê³¼:                                                          â”‚
â”‚  - ì´ë¯¸ íŒŒê´´ëœ ê°ì²´ì˜ ì†Œë©¸ìê°€ ë‹¤ì‹œ í˜¸ì¶œë¨                      â”‚
â”‚  - Undefined Behavior!                                          â”‚
â”‚  - í¬ë˜ì‹œ, ë©”ëª¨ë¦¬ corruption, ì´ìƒí•œ ë™ì‘ ë“±                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### dec_refcount êµ¬í˜„ (ë¬¸ì œ ë²„ì „)

```cpp
uint32_t dec_refcount(void* ptr) override
{
    auto& ref = static_cast<RawStruct*>(ptr)->refcount;
    uint32_t old = ref.fetch_sub(1);

    if (old == 1)  // refcountê°€ 1â†’0ì´ ë¨
    {
        // í•­ìƒ ì†Œë©¸ì í˜¸ì¶œ!
        static_cast<T*>(ptr)->~T();
        dec_refcount_weak(ptr);
    }

    return old;
}
```

---

## í•´ê²°ì±…: destruct_on_zero íŒŒë¼ë¯¸í„°

### ìˆ˜ì •ëœ ì¸í„°í˜ì´ìŠ¤

```cpp
struct SharedBlockAllocator
{
    // destruct_on_zero: refcountê°€ 0ì´ ë  ë•Œ ì†Œë©¸ì í˜¸ì¶œ ì—¬ë¶€
    virtual uint32_t dec_refcount(void* ptr, bool destruct_on_zero = true) = 0;
    // ...
};
```

### ìˆ˜ì •ëœ dec_refcount êµ¬í˜„

```cpp
uint32_t dec_refcount(void* ptr, bool destruct_on_zero = true) override
{
    auto& ref = static_cast<RawStruct*>(ptr)->refcount;
    uint32_t old = ref.fetch_sub(1);

    if (old == 1)  // refcountê°€ 1â†’0ì´ ë¨
    {
        if (destruct_on_zero)  // âœ… ì¡°ê±´ë¶€ ì†Œë©¸
        {
            static_cast<T*>(ptr)->~T();
        }
        dec_refcount_weak(ptr);
    }

    return old;
}
```

### ìˆ˜ì •ëœ weak_ptr::lock()

```cpp
shared_ptr<T> lock()
{
    if (!ptr || !allocator) return {};

    uint32_t old_strong = allocator->inc_refcount(ptr);

    if (old_strong == 0)
    {
        // refcount ë˜ëŒë¦¬ë˜, ì†Œë©¸ìëŠ” í˜¸ì¶œí•˜ì§€ ì•ŠìŒ!
        allocator->dec_refcount(ptr, false);  // âœ… destruct_on_zero = false
        return {};
    }

    shared_ptr<T> ret;
    ret.ptr = ptr;
    ret.allocator = allocator;
    return ret;
}
```

---

## ë‹¤ì´ì–´ê·¸ë¨: ìˆ˜ì • ì „ vs ìˆ˜ì • í›„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ìˆ˜ì • ì „ (ë²„ê·¸)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Timeline:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  [T=0] ê°ì²´ ìƒì„±              refcount=1                        â”‚
â”‚        â”‚                                                        â”‚
â”‚  [T=1] last shared_ptr ì†Œë©¸   refcount=0 â†’ ~T() í˜¸ì¶œ â‘          â”‚
â”‚        â”‚                                                        â”‚
â”‚  [T=2] weak.lock() í˜¸ì¶œ                                         â”‚
â”‚        â”œâ”€ inc_refcount()      refcount=1 (old=0)                â”‚
â”‚        â”œâ”€ old==0 ì´ë¯€ë¡œ                                         â”‚
â”‚        â””â”€ dec_refcount()      refcount=0 â†’ ~T() í˜¸ì¶œ â‘¡ ğŸ’¥      â”‚
â”‚                                                                 â”‚
â”‚  ê²°ê³¼: ì†Œë©¸ì 2ë²ˆ í˜¸ì¶œ â†’ Undefined Behavior                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ìˆ˜ì • í›„ (ì •ìƒ)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Timeline:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  [T=0] ê°ì²´ ìƒì„±              refcount=1                        â”‚
â”‚        â”‚                                                        â”‚
â”‚  [T=1] last shared_ptr ì†Œë©¸   refcount=0 â†’ ~T() í˜¸ì¶œ â‘          â”‚
â”‚        â”‚                                                        â”‚
â”‚  [T=2] weak.lock() í˜¸ì¶œ                                         â”‚
â”‚        â”œâ”€ inc_refcount()      refcount=1 (old=0)                â”‚
â”‚        â”œâ”€ old==0 ì´ë¯€ë¡œ                                         â”‚
â”‚        â””â”€ dec_refcount(false) refcount=0 â†’ ì†Œë©¸ì ìŠ¤í‚µ âœ…      â”‚
â”‚                                                                 â”‚
â”‚  ê²°ê³¼: ì†Œë©¸ì 1ë²ˆë§Œ í˜¸ì¶œ â†’ ì •ìƒ ë™ì‘                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë¹„ìœ : í˜¸í…” ì²´í¬ì•„ì›ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       í˜¸í…” ë¹„ìœ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ìƒí™©: í˜¸í…” ë°© (= ê°ì²´)                                         â”‚
â”‚  - íˆ¬ìˆ™ê° (= shared_ptr) - ë°©ì„ ì‹¤ì œë¡œ ì‚¬ìš©                     â”‚
â”‚  - ì˜ˆì•½ ëŒ€ê¸°ì (= weak_ptr) - ë°©ì´ ë¹„ë©´ ë“¤ì–´ê°€ê³  ì‹¶ìŒ           â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  ë²„ê·¸ ì‹œë‚˜ë¦¬ì˜¤:                                                 â”‚
â”‚                                                                 â”‚
â”‚  1. ë§ˆì§€ë§‰ íˆ¬ìˆ™ê° ì²´í¬ì•„ì›ƒ â†’ ë°© ì²­ì†Œ (ì†Œë©¸ì) â‘                 â”‚
â”‚                                                                 â”‚
â”‚  2. ì˜ˆì•½ ëŒ€ê¸°ìê°€ "ë°© ìˆì–´ìš”?" í™•ì¸                             â”‚
â”‚     - í”„ë¡ íŠ¸: "ì ê¹ë§Œìš”" (inc_refcount)                         â”‚
â”‚     - í™•ì¸: "ì•„, ì´ë¯¸ ì²´í¬ì•„ì›ƒ ì™„ë£Œë¨"                          â”‚
â”‚     - í”„ë¡ íŠ¸: "ì·¨ì†Œí• ê²Œìš”" (dec_refcount)                       â”‚
â”‚     - ğŸ’¥ ë°© ì²­ì†Œ ë‹¤ì‹œ í•¨ (ì†Œë©¸ì) â‘¡ â† ì´ë¯¸ ì²­ì†Œí–ˆëŠ”ë°!         â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  ìˆ˜ì • í›„:                                                       â”‚
â”‚                                                                 â”‚
â”‚  2. ì˜ˆì•½ ëŒ€ê¸°ìê°€ "ë°© ìˆì–´ìš”?" í™•ì¸                             â”‚
â”‚     - í”„ë¡ íŠ¸: "ì ê¹ë§Œìš”" (inc_refcount)                         â”‚
â”‚     - í™•ì¸: "ì•„, ì´ë¯¸ ì²´í¬ì•„ì›ƒ ì™„ë£Œë¨"                          â”‚
â”‚     - í”„ë¡ íŠ¸: "ì·¨ì†Œí• ê²Œìš”, ì²­ì†ŒëŠ” ì•ˆ í•´ë„ ë¼ìš”"                 â”‚
â”‚       (dec_refcount with destruct_on_zero=false)                â”‚
â”‚     - âœ… ì²­ì†Œ ìŠ¤í‚µ                                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì£¼ì˜: ì´ í•´ê²°ì±…ì˜ í•œê³„

### Race Condition ì—¬ì „íˆ ì¡´ì¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ì´ ìˆ˜ì •ìœ¼ë¡œ í•´ê²°ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ë©€í‹°ìŠ¤ë ˆë“œ ì‹œë‚˜ë¦¬ì˜¤:                                           â”‚
â”‚                                                                 â”‚
â”‚  Thread A (weak.lock())        Thread B (allocator)             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  inc_refcount() â†’ old=0                                         â”‚
â”‚                                ê°ì²´ê°€ free_listë¡œ ë°˜í™˜ë¨        â”‚
â”‚                                ìƒˆ ê°ì²´ê°€ ê°™ì€ ë©”ëª¨ë¦¬ì— í• ë‹¹ë¨   â”‚
â”‚  dec_refcount(ptr, false)                                       â”‚
â”‚  â””â”€ ë‹¤ë¥¸ ê°ì²´ì˜ refcount ê°ì†Œ! ğŸ’¥                              â”‚
â”‚                                                                 â”‚
â”‚  ë¬¸ì œ:                                                          â”‚
â”‚  - inc_refcount() í›„ dec_refcount() ì „ì—                        â”‚
â”‚  - ë©”ëª¨ë¦¬ê°€ ì¬ì‚¬ìš©ë  ìˆ˜ ìˆìŒ                                    â”‚
â”‚  - ë‹¤ë¥¸ ê°ì²´ì˜ refcountë¥¼ ê±´ë“œë¦¬ê²Œ ë¨                           â”‚
â”‚                                                                 â”‚
â”‚  â†’ ì»¤ë°‹ #19ì—ì„œ try_inc_refcount()ë¡œ ì™„ì „íˆ í•´ê²°               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ì´ ë¬¸ì œëŠ” **ì»¤ë°‹ #19 (`be8c766e`)**ì—ì„œ `try_inc_refcount()` ë„ì…ìœ¼ë¡œ ì™„ì „íˆ í•´ê²°ë©ë‹ˆë‹¤.

---

## ì°¸ê³ : ì»¤ë°‹ #10 (íƒ€ì´í¬ ìˆ˜ì •)

### ê¸°ë³¸ê°’ ì˜¤ë¥˜

```cpp
// ì»¤ë°‹ #9ì˜ ì‹¤ìˆ˜
virtual uint32_t dec_refcount(void* ptr, bool destruct_on_zero = false) = 0;
//                                                              ^^^^^ ì˜ëª»ë¨!

// ì»¤ë°‹ #10ì—ì„œ ìˆ˜ì •
virtual uint32_t dec_refcount(void* ptr, bool destruct_on_zero = true) = 0;
//                                                              ^^^^ ì˜¬ë°”ë¦„
```

**ì´ìœ **: ëŒ€ë¶€ë¶„ì˜ ê²½ìš° refcountê°€ 0ì´ ë˜ë©´ ì†Œë©¸ìë¥¼ í˜¸ì¶œí•´ì•¼ í•¨. `false`ê°€ ê¸°ë³¸ê°’ì´ë©´ ëª¨ë“  ê°ì²´ê°€ íŒŒê´´ë˜ì§€ ì•ŠìŒ!

---

## VizMotive ì ìš© í˜„í™©

### ì ìš© ì™„ë£Œ âœ…

**ì ìš© ì¼ì**: 2026-01-28

### ì ìš© ìœ„ì¹˜

| íŒŒì¼ | ë¼ì¸ | ë³€ê²½ ë‚´ìš© |
|------|------|----------|
| Allocator.h | SharedBlockAllocator | `dec_refcount(void* ptr, bool destruct_on_zero = true)` |
| Allocator.h | SharedBlockAllocatorImpl | `dec_refcount` êµ¬í˜„ì— ì¡°ê±´ë¶€ ì†Œë©¸ ì¶”ê°€ |
| Allocator.h | weak_ptr::lock() | `dec_refcount(ptr, false)` í˜¸ì¶œ |

### ì½”ë“œ ì˜ˆì‹œ (VizMotive)

```cpp
// Allocator.h - SharedBlockAllocator ì¸í„°í˜ì´ìŠ¤
struct SharedBlockAllocator
{
    virtual uint32_t dec_refcount(void* ptr, bool destruct_on_zero = true) = 0;
    // ...
};

// Allocator.h - SharedBlockAllocatorImpl
uint32_t dec_refcount(void* ptr, bool destruct_on_zero = true) override
{
    auto& ref = static_cast<RawStruct*>(ptr)->refcount;
    uint32_t old = ref.fetch_sub(1);

    if (old == 1)
    {
        if (destruct_on_zero)
        {
            static_cast<T*>(ptr)->~T();
        }
        dec_refcount_weak(ptr);
    }

    return old;
}

// Allocator.h - weak_ptr::lock()
shared_ptr<T> lock()
{
    if (!ptr || !allocator) return {};

    uint32_t old_strong = allocator->inc_refcount(ptr);

    if (old_strong == 0)
    {
        allocator->dec_refcount(ptr, false);  // ì†Œë©¸ì í˜¸ì¶œ ì•ˆ í•¨
        return {};
    }

    shared_ptr<T> ret;
    ret.ptr = ptr;
    ret.allocator = allocator;
    return ret;
}
```

---

## ìš”ì•½

| í•­ëª© | ë‚´ìš© |
|------|------|
| ë¬¸ì œ | weak_ptr::lock()ì—ì„œ ì´ì¤‘ ì†Œë©¸ì í˜¸ì¶œ |
| ì›ì¸ | incâ†’checkâ†’dec ê³¼ì •ì—ì„œ decê°€ í•­ìƒ ì†Œë©¸ì í˜¸ì¶œ |
| í•´ê²° | `dec_refcount(ptr, destruct_on_zero)` íŒŒë¼ë¯¸í„° ì¶”ê°€ |
| í•œê³„ | ë©€í‹°ìŠ¤ë ˆë“œ race condition ì—¬ì „íˆ ì¡´ì¬ (ì»¤ë°‹ #19ì—ì„œ í•´ê²°) |
| VizMotive | âœ… ì ìš© ì™„ë£Œ (2026-01-28) |

### í•µì‹¬ êµí›ˆ

> **refcount ì¡°ì‘ ì‹œ ì†Œë©¸ì í˜¸ì¶œ ì¡°ê±´ ì£¼ì˜**
>
> refcountë¥¼ ì¦ê°€ì‹œì¼°ë‹¤ê°€ ë¡¤ë°±í•  ë•Œ,
> ë‹¨ìˆœíˆ ê°ì†Œì‹œí‚¤ë©´ ì†Œë©¸ìê°€ ë‹¤ì‹œ í˜¸ì¶œë  ìˆ˜ ìˆìŒ.
>
> ë¡¤ë°± ëª©ì ì˜ dec_refcountëŠ” ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ë©´ ì•ˆ ë¨.

> **ì´ ìˆ˜ì •ì€ ë¶ˆì™„ì „í•¨**
>
> ë‹¨ì¼ ìŠ¤ë ˆë“œì—ì„œëŠ” ë¬¸ì œ í•´ê²°ë¨.
> ë©€í‹°ìŠ¤ë ˆë“œì—ì„œëŠ” incâ†’dec ì‚¬ì´ì— ë©”ëª¨ë¦¬ ì¬ì‚¬ìš© ê°€ëŠ¥.
> ì™„ì „í•œ í•´ê²°ì€ ì»¤ë°‹ #19ì˜ `try_inc_refcount()` ì°¸ì¡°.
