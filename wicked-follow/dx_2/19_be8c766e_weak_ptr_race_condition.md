# ì»¤ë°‹ #19: be8c766e - Fixed critical issue with weak_ptr

## ê¸°ë³¸ ì •ë³´

| í•­ëª© | ë‚´ìš© |
|------|------|
| ì»¤ë°‹ í•´ì‹œ | `be8c766e` |
| ë‚ ì§œ | 2025-12-14 |
| ì‘ì„±ì | TurÃ¡nszki JÃ¡nos |
| ì¹´í…Œê³ ë¦¬ | ë²„ê·¸ìˆ˜ì • / ì•ˆì •ì„± |
| ìš°ì„ ìˆœìœ„ | ë†’ìŒ (Critical) |

## ë³€ê²½ íŒŒì¼ ìš”ì•½

| íŒŒì¼ | ë³€ê²½ |
|------|------|
| wiAllocator.h | `try_inc_refcount()` ë„ì…, `destruct_on_zero` íŒŒë¼ë¯¸í„° ì œê±° |

---

## ë°°ê²½: ì»¤ë°‹ #9ì˜ ë¶ˆì™„ì „í•œ í•´ê²°ì±…

### ì»¤ë°‹ #9 ë³µìŠµ

ì»¤ë°‹ #9ì—ì„œ `destruct_on_zero` íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ì—¬ ì´ì¤‘ ì†Œë©¸ì í˜¸ì¶œì„ ë°©ì§€í–ˆìŠµë‹ˆë‹¤:

```cpp
shared_ptr<T> lock()
{
    uint32_t old_strong = allocator->inc_refcount(ptr);  // Step 1
    if (old_strong == 0)
    {
        allocator->dec_refcount(ptr, false);  // Step 2: ì†Œë©¸ì ìŠ¤í‚µ
        return {};
    }
    // ...
}
```

**ë‹¨ì¼ ìŠ¤ë ˆë“œ**ì—ì„œëŠ” ì´ ë°©ì‹ì´ ë™ì‘í•©ë‹ˆë‹¤.

---

## ë¬¸ì œ: ë©€í‹°ìŠ¤ë ˆë“œ Race Condition

### ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ë©€í‹°ìŠ¤ë ˆë“œ Race Condition                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Thread A (weak.lock())        Allocator (ë‹¤ë¥¸ ìŠ¤ë ˆë“œ)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                                 â”‚
â”‚  T=0: inc_refcount(ptr)                                         â”‚
â”‚       refcount: 0 â†’ 1                                           â”‚
â”‚       old_strong = 0                                            â”‚
â”‚            â”‚                                                    â”‚
â”‚            â”‚                   T=1: weak_refcountê°€ 0ì´ ë¨      â”‚
â”‚            â”‚                        ë©”ëª¨ë¦¬ê°€ free_listë¡œ ë°˜í™˜   â”‚
â”‚            â”‚                                                    â”‚
â”‚            â”‚                   T=2: ìƒˆ ê°ì²´ Bê°€ ê°™ì€ ë©”ëª¨ë¦¬ì—   â”‚
â”‚            â”‚                        í• ë‹¹ë¨                      â”‚
â”‚            â”‚                        Bì˜ refcount = 1            â”‚
â”‚            â”‚                                                    â”‚
â”‚  T=3: dec_refcount(ptr, false)                                  â”‚
â”‚       ğŸ’¥ Bì˜ refcount: 1 â†’ 0                                   â”‚
â”‚       (Bê°€ íŒŒê´´ë˜ë©´ ì•ˆ ë˜ëŠ”ë°!)                                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìƒì„¸ ë¶„ì„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Race Condition ìƒì„¸                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ë©”ëª¨ë¦¬ ì¬ì‚¬ìš© ë¬¸ì œ:                                            â”‚
â”‚                                                                 â”‚
â”‚  [Before]                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Memory Address 0x1000                                    â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ Object A (destroyed)                               â”‚   â”‚   â”‚
â”‚  â”‚ â”‚ refcount = 0 (ì›ë˜ ê°’)                             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚ weak_refcount = 1 (weak_ptrì´ ì•„ì§ ì°¸ì¡° ì¤‘)       â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Thread A: inc_refcount(0x1000) â†’ refcount = 1, returns 0       â”‚
â”‚                                                                 â”‚
â”‚  [Context Switch - Thread B runs]                               â”‚
â”‚                                                                 â”‚
â”‚  Thread B: weak_refcountë„ 0ì´ ë¨ â†’ ë©”ëª¨ë¦¬ free_listë¡œ ë°˜í™˜     â”‚
â”‚  Thread B: ìƒˆ í• ë‹¹ ìš”ì²­ â†’ 0x1000 ì¬ì‚¬ìš©                         â”‚
â”‚                                                                 â”‚
â”‚  [After - Same Memory, Different Object!]                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Memory Address 0x1000                                    â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ Object B (ìƒˆë¡œ ìƒì„±ë¨)                             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚ refcount = 1 (ì •ìƒ)                                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚ weak_refcount = 1 (ì •ìƒ)                           â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [Thread A resumes]                                             â”‚
â”‚                                                                 â”‚
â”‚  Thread A: dec_refcount(0x1000, false)                          â”‚
â”‚            â†’ Object Bì˜ refcount: 1 â†’ 0                        â”‚
â”‚            â†’ Object Bê°€ ì˜ë„ì¹˜ ì•Šê²Œ ì˜í–¥ë°›ìŒ!                   â”‚
â”‚                                                                 â”‚
â”‚  ê²°ê³¼:                                                          â”‚
â”‚  - destruct_on_zero=falseë¼ì„œ ì†Œë©¸ìëŠ” ì•ˆ í˜¸ì¶œë˜ì§€ë§Œ            â”‚
â”‚  - Bì˜ refcountê°€ 0ì´ ë¨ â†’ Bë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ì½”ë“œì—ì„œ ë¬¸ì œ      â”‚
â”‚  - ë˜ëŠ” weak_refcount ê°ì†Œë¡œ ë©”ëª¨ë¦¬ ì¬ë°˜í™˜ â†’ use-after-free    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì™œ ì´ëŸ° ì¼ì´ ë°œìƒí•˜ëŠ”ê°€?

```
í•µì‹¬ ë¬¸ì œ: inc_refcount()ì™€ ì¡°ê±´ ì²´í¬ê°€ ì›ìì ì´ì§€ ì•ŠìŒ

inc_refcount(ptr);          // ì›ìì 
                           // â† ì—¬ê¸°ì„œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ!
if (old_strong == 0) {     // ë¹„ì›ìì  ì²´í¬
    dec_refcount(ptr);     // ì›ìì ì´ì§€ë§Œ ì´ë¯¸ ë‹¤ë¥¸ ê°ì²´
}

ë‘ ì—°ì‚° ì‚¬ì´ì˜ "window"ì—ì„œ ë©”ëª¨ë¦¬ê°€ ì¬ì‚¬ìš©ë  ìˆ˜ ìˆìŒ
```

---

## í•´ê²°ì±…: try_inc_refcount()

### í•µì‹¬ ì•„ì´ë””ì–´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Compare-And-Swap (CAS) ê¸°ë°˜ í•´ê²°                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ê¸°ì¡´ ë°©ì‹ (2ë‹¨ê³„, ë¹„ì›ìì ):                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  1. inc_refcount() - ë¬´ì¡°ê±´ ì¦ê°€                                â”‚
â”‚  2. if (old == 0) dec_refcount() - ë¡¤ë°±                         â”‚
â”‚                                                                 â”‚
â”‚  ë¬¸ì œ: 1ê³¼ 2 ì‚¬ì´ì— race condition                              â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  ìƒˆë¡œìš´ ë°©ì‹ (1ë‹¨ê³„, ì›ìì ):                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  try_inc_refcount() - 0ì´ ì•„ë‹ ë•Œë§Œ ì›ìì ìœ¼ë¡œ ì¦ê°€             â”‚
â”‚                                                                 â”‚
â”‚  CAS (Compare-And-Swap) ì‚¬ìš©:                                   â”‚
â”‚  "í˜„ì¬ ê°’ì´ expectedì™€ ê°™ìœ¼ë©´ new_valueë¡œ êµì²´"                 â”‚
â”‚  "ê°™ì§€ ì•Šìœ¼ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨"                                   â”‚
â”‚  â†’ ì›ìì  ì—°ì‚°ìœ¼ë¡œ race condition ì—†ìŒ!                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### try_inc_refcount() êµ¬í˜„

```cpp
bool try_inc_refcount(void* ptr) override
{
    auto& ref = static_cast<RawStruct*>(ptr)->refcount;

    // í˜„ì¬ refcount ê°’ ì½ê¸°
    uint32_t expected = ref.load(std::memory_order_acquire);

    do {
        // refcountê°€ 0ì´ë©´ ì‹¤íŒ¨ (ê°ì²´ ì´ë¯¸ íŒŒê´´ë¨)
        if (expected == 0)
        {
            return false;
        }

        // CAS: expected ê°’ì´ë©´ expected+1ë¡œ êµì²´
        // ì‹¤íŒ¨í•˜ë©´ expectedì— í˜„ì¬ ê°’ì´ ì €ì¥ë˜ê³  ë£¨í”„ ì¬ì‹œë„
    } while (!ref.compare_exchange_weak(
        expected,           // expected value
        expected + 1,       // desired value (ì¦ê°€)
        std::memory_order_acq_rel,
        std::memory_order_acquire
    ));

    return true;  // ì¦ê°€ ì„±ê³µ
}
```

### CAS ë™ì‘ ì›ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              compare_exchange_weak ë™ì‘                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ref.compare_exchange_weak(expected, desired)                   â”‚
â”‚                                                                 â”‚
â”‚  ì˜ì‚¬ ì½”ë“œ (ì›ìì ìœ¼ë¡œ ì‹¤í–‰ë¨):                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ if (ref == expected) {                                   â”‚   â”‚
â”‚  â”‚     ref = desired;    // êµì²´ ì„±ê³µ                       â”‚   â”‚
â”‚  â”‚     return true;                                         â”‚   â”‚
â”‚  â”‚ } else {                                                 â”‚   â”‚
â”‚  â”‚     expected = ref;   // í˜„ì¬ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸            â”‚   â”‚
â”‚  â”‚     return false;     // ì¬ì‹œë„ í•„ìš”                     â”‚   â”‚
â”‚  â”‚ }                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ì˜ˆì‹œ:                                                          â”‚
â”‚  â”€â”€â”€â”€â”€                                                          â”‚
â”‚  refcount = 2                                                   â”‚
â”‚  expected = 2                                                   â”‚
â”‚  desired = 3                                                    â”‚
â”‚                                                                 â”‚
â”‚  Case 1: ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì•ˆ ê±´ë“œë¦¼                                â”‚
â”‚  â†’ ref(2) == expected(2) â†’ ref = 3, return true                â”‚
â”‚                                                                 â”‚
â”‚  Case 2: ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ refcountë¥¼ 1ë¡œ ê°ì†Œì‹œí‚´                  â”‚
â”‚  â†’ ref(1) != expected(2) â†’ expected = 1, return false          â”‚
â”‚  â†’ ë£¨í”„ ì¬ì‹œë„: expected=1, desired=2ë¡œ ë‹¤ì‹œ CAS               â”‚
â”‚                                                                 â”‚
â”‚  Case 3: refcountê°€ 0ì„ (ê°ì²´ íŒŒê´´ë¨)                           â”‚
â”‚  â†’ expected == 0 ì²´í¬ì—ì„œ ì¦‰ì‹œ return false                     â”‚
â”‚  â†’ CAS ì‹œë„ ì•ˆ í•¨, ì•ˆì „í•˜ê²Œ ì‹¤íŒ¨                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìˆ˜ì •ëœ weak_ptr::lock()

```cpp
shared_ptr<T> lock()
{
    if (!ptr || !allocator) return {};

    // ì›ìì ìœ¼ë¡œ refcount ì¦ê°€ ì‹œë„
    if (allocator->try_inc_refcount(ptr))
    {
        // ì„±ê³µ: shared_ptr ë°˜í™˜
        shared_ptr<T> ret;
        ret.ptr = ptr;
        ret.allocator = allocator;
        return ret;
    }

    // ì‹¤íŒ¨: ê°ì²´ê°€ ì´ë¯¸ íŒŒê´´ë¨
    return {};
}
```

---

## ë¹„êµ: ì´ì „ vs ì´í›„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ìˆ˜ì • ì „ vs ìˆ˜ì • í›„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ìˆ˜ì • ì „ (#9):                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  shared_ptr<T> lock() {                                         â”‚
â”‚      uint32_t old = allocator->inc_refcount(ptr);  // ë¬´ì¡°ê±´ +1â”‚
â”‚      if (old == 0) {                                            â”‚
â”‚          allocator->dec_refcount(ptr, false);      // ë¡¤ë°±      â”‚
â”‚          return {};                                             â”‚
â”‚      }                                                          â”‚
â”‚      // ...                                                     â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  ë¬¸ì œ:                                                          â”‚
â”‚  - incì™€ if ì‚¬ì´ì— race condition                               â”‚
â”‚  - ë¡¤ë°±ì´ ë‹¤ë¥¸ ê°ì²´ì— ì˜í–¥ ì¤„ ìˆ˜ ìˆìŒ                           â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  ìˆ˜ì • í›„ (#19):                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  shared_ptr<T> lock() {                                         â”‚
â”‚      if (allocator->try_inc_refcount(ptr)) {       // ì›ìì     â”‚
â”‚          // ì„±ê³µ                                                â”‚
â”‚          // ...                                                 â”‚
â”‚      }                                                          â”‚
â”‚      return {};  // ì‹¤íŒ¨ - ë¡¤ë°± í•„ìš” ì—†ìŒ!                      â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  ì¥ì :                                                          â”‚
â”‚  - ì›ìì  ì—°ì‚°ìœ¼ë¡œ race condition ì—†ìŒ                          â”‚
â”‚  - ì‹¤íŒ¨ ì‹œ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (ë¡¤ë°± ë¶ˆí•„ìš”)                         â”‚
â”‚  - ì½”ë“œê°€ ë” ë‹¨ìˆœí•¨                                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì¸í„°í˜ì´ìŠ¤ ë³€ê²½

```cpp
// ìˆ˜ì • ì „ (#9)
struct SharedBlockAllocator
{
    virtual uint32_t inc_refcount(void* ptr) = 0;
    virtual uint32_t dec_refcount(void* ptr, bool destruct_on_zero = true) = 0;
    // ...
};

// ìˆ˜ì • í›„ (#19)
struct SharedBlockAllocator
{
    virtual uint32_t inc_refcount(void* ptr) = 0;
    virtual uint32_t dec_refcount(void* ptr) = 0;  // íŒŒë¼ë¯¸í„° ì œê±°!
    virtual bool try_inc_refcount(void* ptr) = 0;  // ìƒˆë¡œ ì¶”ê°€!
    // ...
};
```

`destruct_on_zero` íŒŒë¼ë¯¸í„°ê°€ ë” ì´ìƒ í•„ìš” ì—†ì–´ì¡ŒìŠµë‹ˆë‹¤!

---

## ë‹¤ì´ì–´ê·¸ë¨: Race Condition í•´ê²°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              try_inc_refcountë¡œ Race Condition í•´ê²°              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ì‹œë‚˜ë¦¬ì˜¤: Object A íŒŒê´´ë¨ (refcount=0), weak_ptrì´ lock() ì‹œë„ â”‚
â”‚                                                                 â”‚
â”‚  Thread A (weak.lock())        Thread B (allocator)             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                                 â”‚
â”‚  try_inc_refcount(ptr):                                         â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ expected = load(refcount)                                    â”‚
â”‚  â”‚ expected = 0                                                 â”‚
â”‚  â”‚ â”‚                                                            â”‚
â”‚  â”‚ â””â”€ if (expected == 0)                                       â”‚
â”‚  â”‚       return false; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚    (CASëŠ” ì‹œë„ì¡°ì°¨ ì•ˆ í•¨!)                               â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  lock() returns {}    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ê²°ê³¼:                                                          â”‚
â”‚  - refcountëŠ” í•œ ë²ˆë„ ê±´ë“œë¦¬ì§€ ì•ŠìŒ                             â”‚
â”‚  - ë©”ëª¨ë¦¬ ì¬ì‚¬ìš©ë˜ì–´ë„ ì˜í–¥ ì—†ìŒ                                â”‚
â”‚  - ì•ˆì „í•˜ê²Œ ì‹¤íŒ¨                                                â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  ì‹œë‚˜ë¦¬ì˜¤: Object A ì‚´ì•„ìˆìŒ (refcount=1)                       â”‚
â”‚                                                                 â”‚
â”‚  try_inc_refcount(ptr):                                         â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ expected = 1                                                 â”‚
â”‚  â”‚ â”‚                                                            â”‚
â”‚  â”‚ â””â”€ CAS: if (ref==1) ref=2  â”€â”€â”                              â”‚
â”‚  â”‚                               â”‚                              â”‚
â”‚  â”‚                    (ì›ìì )   â”‚                              â”‚
â”‚  â”‚                               â–¼                              â”‚
â”‚  â”‚    return true; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  lock() returns shared_ptr  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ê²°ê³¼:                                                          â”‚
â”‚  - refcountê°€ ì›ìì ìœ¼ë¡œ 1â†’2                                    â”‚
â”‚  - ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë¼ì–´ë“¤ í‹ˆ ì—†ìŒ                                 â”‚
â”‚  - ì•ˆì „í•˜ê²Œ ì„±ê³µ                                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë¹„ìœ : ì¢Œì„ ì˜ˆì•½ ì‹œìŠ¤í…œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì¢Œì„ ì˜ˆì•½ ë¹„ìœ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ìˆ˜ì • ì „ (#9) - 2ë‹¨ê³„ ì˜ˆì•½:                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â”‚
â”‚  1. "ì´ ì¢Œì„ ì˜ˆì•½í•©ë‹ˆë‹¤" (inc_refcount)                         â”‚
â”‚  2. ì‹œìŠ¤í…œ: "ì´ë¯¸ ê³µì—° ëë‚¬ë„¤ìš”" (old == 0)                     â”‚
â”‚  3. "ê·¸ëŸ¼ ì·¨ì†Œí• ê²Œìš”" (dec_refcount)                            â”‚
â”‚                                                                 â”‚
â”‚  ë¬¸ì œ: 2ì™€ 3 ì‚¬ì´ì— ë‹¤ë¥¸ ê³µì—°ì´ ì‹œì‘ë˜ë©´?                       â”‚
â”‚  â†’ ë‹¤ë¥¸ ê³µì—°ì˜ ì¢Œì„ì„ ì·¨ì†Œí•˜ê²Œ ë¨!                              â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  ìˆ˜ì • í›„ (#19) - ì¡°ê±´ë¶€ ì˜ˆì•½:                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â”‚
â”‚  "ê³µì—°ì´ ì•„ì§ ì§„í–‰ ì¤‘ì´ë©´ ì˜ˆì•½í•´ì£¼ì„¸ìš”" (try_inc_refcount)      â”‚
â”‚                                                                 â”‚
â”‚  ì‹œìŠ¤í…œ (ì›ìì ìœ¼ë¡œ):                                           â”‚
â”‚  - ê³µì—° ì§„í–‰ ì¤‘? â†’ ì˜ˆì•½ ì™„ë£Œ, return true                       â”‚
â”‚  - ê³µì—° ëë‚¨? â†’ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨, return false                    â”‚
â”‚                                                                 â”‚
â”‚  â†’ ì ˆëŒ€ ì˜ëª»ëœ ê³µì—°ì˜ ì¢Œì„ì„ ê±´ë“œë¦¬ì§€ ì•ŠìŒ!                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Memory Ordering ì„¤ëª…

### ì™œ memory_orderê°€ í•„ìš”í•œê°€?

```cpp
ref.compare_exchange_weak(
    expected,
    expected + 1,
    std::memory_order_acq_rel,   // ì„±ê³µ ì‹œ
    std::memory_order_acquire    // ì‹¤íŒ¨ ì‹œ
);
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Memory Ordering                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  memory_order_acquire:                                          â”‚
â”‚  - ì´ ì—°ì‚° ì´í›„ì˜ ì½ê¸°/ì“°ê¸°ê°€ ì´ ì—°ì‚° ì´ì „ìœ¼ë¡œ ì¬ë°°ì¹˜ë˜ì§€ ì•ŠìŒ  â”‚
â”‚  - "ì´ ì‹œì  ì´í›„ì˜ ë©”ëª¨ë¦¬ ì ‘ê·¼ì€ ìµœì‹  ê°’ì„ ë³¸ë‹¤"                â”‚
â”‚                                                                 â”‚
â”‚  memory_order_release:                                          â”‚
â”‚  - ì´ ì—°ì‚° ì´ì „ì˜ ì½ê¸°/ì“°ê¸°ê°€ ì´ ì—°ì‚° ì´í›„ë¡œ ì¬ë°°ì¹˜ë˜ì§€ ì•ŠìŒ    â”‚
â”‚  - "ì´ ì‹œì ê¹Œì§€ì˜ ì“°ê¸°ê°€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì— ë³´ì¸ë‹¤"                  â”‚
â”‚                                                                 â”‚
â”‚  memory_order_acq_rel:                                          â”‚
â”‚  - acquire + release ë‘˜ ë‹¤                                      â”‚
â”‚  - CAS ì„±ê³µ ì‹œ í•„ìš” (ì½ê¸°ë„ í•˜ê³  ì“°ê¸°ë„ í•¨)                     â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  try_inc_refcountì—ì„œ:                                          â”‚
â”‚                                                                 â”‚
â”‚  ì„±ê³µ ì‹œ (acq_rel):                                             â”‚
â”‚  - refcount ì¦ê°€ê°€ í™•ì‹¤íˆ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì— ë³´ì„                    â”‚
â”‚  - ì´í›„ ê°ì²´ ì ‘ê·¼ì´ ì˜¬ë°”ë¥¸ ê°’ì„ ì½ìŒ                            â”‚
â”‚                                                                 â”‚
â”‚  ì‹¤íŒ¨ ì‹œ (acquire):                                             â”‚
â”‚  - í˜„ì¬ refcount ê°’ì„ ì •í™•íˆ ì½ìŒ                               â”‚
â”‚  - ì¬ì‹œë„ ì‹œ ìµœì‹  ê°’ìœ¼ë¡œ ë¹„êµ                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## VizMotive ì ìš© í˜„í™©

### ì ìš© ì™„ë£Œ âœ…

**ì ìš© ì¼ì**: 2026-01-29

### ì ìš© ìœ„ì¹˜

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| Allocator.h | `SharedBlockAllocator::try_inc_refcount()` ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€ |
| Allocator.h | `dec_refcount()`ì—ì„œ `destruct_on_zero` íŒŒë¼ë¯¸í„° ì œê±° |
| Allocator.h | `SharedBlockAllocatorImpl::try_inc_refcount()` CAS êµ¬í˜„ |
| Allocator.h | `SharedHeapAllocator::try_inc_refcount()` êµ¬í˜„ |
| Allocator.h | `weak_ptr::lock()`ì—ì„œ `try_inc_refcount()` ì‚¬ìš© |

### ì½”ë“œ ì˜ˆì‹œ (VizMotive)

```cpp
// SharedBlockAllocator ì¸í„°í˜ì´ìŠ¤
struct SharedBlockAllocator
{
    virtual uint32_t inc_refcount(void* ptr) = 0;
    virtual uint32_t dec_refcount(void* ptr) = 0;  // destruct_on_zero ì œê±°
    virtual bool try_inc_refcount(void* ptr) = 0;  // ìƒˆë¡œ ì¶”ê°€
    // ...
};

// SharedBlockAllocatorImpl
bool try_inc_refcount(void* ptr) override
{
    auto& ref = static_cast<RawStruct*>(ptr)->refcount;
    uint32_t expected = ref.load(std::memory_order_acquire);

    do {
        if (expected == 0) return false;
    } while (!ref.compare_exchange_weak(
        expected, expected + 1,
        std::memory_order_acq_rel,
        std::memory_order_acquire
    ));

    return true;
}

// weak_ptr::lock()
shared_ptr<T> lock()
{
    if (!ptr || !allocator) return {};

    if (allocator->try_inc_refcount(ptr))
    {
        shared_ptr<T> ret;
        ret.ptr = ptr;
        ret.allocator = allocator;
        return ret;
    }
    return {};
}
```

---

## ìš”ì•½

| í•­ëª© | ë‚´ìš© |
|------|------|
| ë¬¸ì œ | ì»¤ë°‹ #9ì˜ incâ†’dec ë°©ì‹ì€ ë©€í‹°ìŠ¤ë ˆë“œì—ì„œ race condition |
| ì›ì¸ | incì™€ ì¡°ê±´ ì²´í¬ê°€ ì›ìì ì´ì§€ ì•ŠìŒ, ê·¸ ì‚¬ì´ì— ë©”ëª¨ë¦¬ ì¬ì‚¬ìš© ê°€ëŠ¥ |
| í•´ê²° | `try_inc_refcount()` - CASë¡œ ì›ìì ìœ¼ë¡œ "0ì´ ì•„ë‹ˆë©´ ì¦ê°€" |
| ë¶€ìˆ˜ íš¨ê³¼ | `destruct_on_zero` íŒŒë¼ë¯¸í„° ë¶ˆí•„ìš”í•´ì ¸ì„œ ì œê±° |
| VizMotive | âœ… ì ìš© ì™„ë£Œ (2026-01-29) |

### í•µì‹¬ êµí›ˆ

> **ë©€í‹°ìŠ¤ë ˆë“œì—ì„œ "ì²´í¬ í›„ í–‰ë™"ì€ ìœ„í—˜**
>
> ```cpp
> // ìœ„í—˜í•œ íŒ¨í„´
> if (condition) {
>     do_something();  // conditionì´ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆìŒ!
> }
> ```
>
> ì²´í¬ì™€ í–‰ë™ì„ ì›ìì ìœ¼ë¡œ ë¬¶ì–´ì•¼ í•¨.
> CAS (Compare-And-Swap)ê°€ ì´ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•¨.

> **weak_ptr::lock()ì˜ ì˜¬ë°”ë¥¸ êµ¬í˜„**
>
> - ì‹¤íŒ¨ ì‹œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šì•„ì•¼ í•¨
> - incâ†’checkâ†’dec íŒ¨í„´ì€ race condition ìœ ë°œ
> - try_inc_refcount()ë¡œ ì›ìì  ì¡°ê±´ë¶€ ì¦ê°€ í•„ìš”

> **std::atomicì˜ compare_exchange_weak**
>
> - "í˜„ì¬ ê°’ì´ expectedë©´ desiredë¡œ êµì²´"
> - ì‹¤íŒ¨í•˜ë©´ expectedì— í˜„ì¬ ê°’ ì €ì¥ â†’ ë£¨í”„ë¡œ ì¬ì‹œë„
> - Lock-free ì•Œê³ ë¦¬ì¦˜ì˜ í•µì‹¬ primitive
