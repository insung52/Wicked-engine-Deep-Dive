# Topic: Custom Allocator & shared_ptr (ì»¤ìŠ¤í…€ í• ë‹¹ì)

## ê°œìš”

`std::shared_ptr`ì˜ í™ í• ë‹¹ ì˜¤ë²„í—¤ë“œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ Block Allocator ê¸°ë°˜ ì»¤ìŠ¤í…€ shared_ptr ì‹œìŠ¤í…œ.

## ê´€ë ¨ ì»¤ë°‹

| ìˆœì„œ | ì»¤ë°‹ | ë‚ ì§œ | í•µì‹¬ ë³€ê²½ |
|------|------|------|----------|
| 1 | [dx2 #3 `a6adfc12`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/03_a6adfc12_block_allocator_alignment.md) | 2025-11-02 | BlockAllocator alignment ë³´ì¥ |
| 2 | [dx2 #4 `359ade8d`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/04_359ade8d_move_semantics_const.md) | 2025-11-14 | Move semantics, const ì •í™•ì„± |
| 3 | [dx2 #8 `7a5ea2f6`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/08_7a5ea2f6_pooled_shared_ptr.md) | 2025-11-22 | **pooled shared_ptr ë„ì…** |
| 4 | [dx2 #9 `e1dc87e4`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/09_e1dc87e4_weak_ptr_double_destruct.md) | 2025-11-23 | weak_ptr ì´ì¤‘ ì†Œë©¸ì ë°©ì§€ |
| 5 | [dx2 #10 `16a19429`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/10_16a19429_destruct_on_zero_typo.md) | 2025-11-23 | destruct_on_zero ê¸°ë³¸ê°’ ìˆ˜ì • |
| 6 | [dx2 #11 `90e94ed4`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/11_90e94ed4_placement_new_allowed.md) | 2025-11-24 | placement new í—ˆìš© |
| 7 | [dx2 #12 `ffcc3abd`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/12_ffcc3abd_shared_heap_allocator.md) | 2025-11-25 | SharedHeapAllocator ì¶”ê°€ |
| 8 | [dx2 #13 `051bfb60`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/13_051bfb60_self_assign_check.md) | 2025-11-26 | self-assign ì²´í¬ |
| 9 | [dx2 #19 `be8c766e`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/19_be8c766e_weak_ptr_race_condition.md) | 2025-12-14 | **weak_ptr race condition í•´ê²°** |
| 10 | [dx2 #22 `43b93085`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/22_43b93085_block_allocator_commandlist.md) | 2026-01-15 | CommandList BlockAllocator ì ìš© |
| 11 | [dx2 #18 `7ecbc25a`](https://github.com/insung52/Wicked-engine-Deep-Dive/blob/main/wicked-follow/dx_2/18_7ecbc25a_d3d12memalloc_update.md) | 2025-12-06 | D3D12MemAlloc 3.0.1 ì—…ë°ì´íŠ¸ |

---

## ë°°ê²½: std::shared_ptrì˜ ë¬¸ì œì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              std::shared_ptr ë¬¸ì œì                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ë¹ˆë²ˆí•œ í™ í• ë‹¹/í•´ì œ                                           â”‚
â”‚     Graphics ê°ì²´ (Texture, Buffer, Shader)ëŠ” í”„ë ˆì„ë§ˆë‹¤          â”‚
â”‚     ìƒì„±/ì‚­ì œë  ìˆ˜ ìˆìŒ â†’ ë§¤ë²ˆ í™ í• ë‹¹ ì˜¤ë²„í—¤ë“œ                      â”‚
â”‚                                                                 â”‚
â”‚  2. ë©”ëª¨ë¦¬ ë‹¨í¸í™”                                                 â”‚
â”‚     â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”     â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”     â”Œâ”€â”€â”€â”                       â”‚
â”‚     â”‚ A â”‚ â”‚ B â”‚ ... â”‚ C â”‚ â”‚ D â”‚ ... â”‚ E â”‚  â† í©ì–´ì§„ í• ë‹¹         â”‚
â”‚     â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜                       â”‚
â”‚     ìºì‹œ ë¯¸ìŠ¤ ì¦ê°€, ë©”ëª¨ë¦¬ íš¨ìœ¨ ê°ì†Œ                                â”‚
â”‚                                                                 â”‚
â”‚  3. Control Block ì˜¤ë²„í—¤ë“œ                                       â”‚
â”‚     ê°ì²´ë‹¹ ~24ë°”ì´íŠ¸ ì¶”ê°€ (refcount + weak_count + ...)           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë³€í™” íë¦„

### Phase 1: BlockAllocator ê¸°ë°˜ ë§ˆë ¨ (ì»¤ë°‹ #3, #4)

**BlockAllocator alignment ë³´ì¥ (#3)**

```cpp
// ë¬¸ì œ: uint8_t[]ëŠ” 1ë°”ì´íŠ¸ ì •ë ¬ë§Œ ë³´ì¥
struct Block {
    std::vector<uint8_t[]> mem;  // Tì˜ ì •ë ¬ ìš”êµ¬ì‚¬í•­ ë¬´ì‹œ!
};

// í•´ê²°: alignasë¡œ ì •ë ¬ ë³´ì¥
struct alignas(alignof(T)) RawStruct {
    uint8_t data[sizeof(T)];
};
```

**Move semantics (#4)**

```cpp
// ë¶ˆí•„ìš”í•œ ë³µì‚¬ ë°©ì§€
BlockAllocator(BlockAllocator&& other) noexcept
    : blocks(std::move(other.blocks))
    , free_list(std::move(other.free_list)) {}
```

---

### Phase 2: pooled shared_ptr ë„ì… (ì»¤ë°‹ #8)

**í•µì‹¬ ì•„ì´ë””ì–´**: ê°™ì€ íƒ€ì… ê°ì²´ë¥¼ ì—°ì† ë©”ëª¨ë¦¬ì— í’€ë§

```
std::shared_ptr (ê¸°ì¡´):
â”Œâ”€â”€â”€â”     â”Œâ”€â”€â”€â”     â”Œâ”€â”€â”€â”     â”Œâ”€â”€â”€â”
â”‚ A â”‚     â”‚ B â”‚     â”‚ C â”‚     â”‚ D â”‚  â† ê°œë³„ í™ í• ë‹¹
â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜     â””â”€â”€â”€â”˜
  â†‘         â†‘         â†‘         â†‘
 new       new       new       new

Block Allocator ê¸°ë°˜ (ìƒˆë¡œìš´):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Block 0                                             â”‚
â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ A â”‚ B â”‚ C â”‚ D â”‚ E â”‚ F â”‚ G â”‚ H â”‚ ... (256ê°œ)     â”‚ â”‚
â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
               í•œ ë²ˆì˜ ë²¡í„° í™•ì¥
```

**ì„±ëŠ¥ ë¹„êµ**:

| ì—°ì‚° | std::shared_ptr | Pooled shared_ptr |
|------|-----------------|-------------------|
| í• ë‹¹ | ~100-1000 cycles | ~10-50 cycles (O(1)) |
| í•´ì œ | ~100-1000 cycles | ~10-50 cycles (O(1)) |
| ìºì‹œ íš¨ìœ¨ | ë‚®ìŒ (í©ì–´ì§„) | ë†’ìŒ (ì—°ì†) |

---

### Phase 3: weak_ptr ë²„ê·¸ ìˆ˜ì • (ì»¤ë°‹ #9, #10, #19)

**ë¬¸ì œ 1: ì´ì¤‘ ì†Œë©¸ì í˜¸ì¶œ (#9)**

```cpp
// weak_ptr::lock() ì‹œë„
shared_ptr<T> lock() {
    uint32_t old = allocator->inc_refcount(ptr);  // 0 â†’ 1
    if (old == 0) {
        allocator->dec_refcount(ptr);  // 1 â†’ 0 â†’ ì†Œë©¸ì ì¬í˜¸ì¶œ!
        return {};
    }
}
```

**í•´ê²° (#9)**: `destruct_on_zero=false` íŒŒë¼ë¯¸í„° ì¶”ê°€

**ë¬¸ì œ 2: ë©€í‹°ìŠ¤ë ˆë“œ race condition (#19)**

```
Thread A (weak.lock())        Thread B (allocator)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

inc_refcount(ptr)
  refcount: 0 â†’ 1
                              ë©”ëª¨ë¦¬ê°€ free_listë¡œ ë°˜í™˜
                              ìƒˆ ê°ì²´ Bê°€ ê°™ì€ ë©”ëª¨ë¦¬ì— í• ë‹¹
                              Bì˜ refcount = 1

dec_refcount(ptr, false)
  ğŸ’¥ Bì˜ refcount: 1 â†’ 0
```

**í•´ê²° (#19)**: CAS ê¸°ë°˜ `try_inc_refcount()`

```cpp
bool try_inc_refcount(void* ptr) override {
    auto& ref = static_cast<RawStruct*>(ptr)->refcount;
    uint32_t expected = ref.load(std::memory_order_acquire);

    do {
        if (expected == 0) return false;  // ì¦‰ì‹œ ì‹¤íŒ¨
    } while (!ref.compare_exchange_weak(
        expected, expected + 1,
        std::memory_order_acq_rel,
        std::memory_order_acquire
    ));

    return true;
}
```

**í•µì‹¬**: "0ì´ ì•„ë‹ˆë©´ ì¦ê°€"ë¥¼ **ì›ìì ìœ¼ë¡œ** ìˆ˜í–‰

---

### Phase 4: ê°œì„  ë° í™•ì¥ (ì»¤ë°‹ #11, #12, #13, #22)

**placement new í—ˆìš© (#11)**

ì»¤ë°‹ #7ì—ì„œ ëª¨ë“  newë¥¼ ê¸ˆì§€í–ˆìœ¼ë‚˜, Block AllocatorëŠ” placement new í•„ìš”:

```cpp
// í—ˆìš©ë¨ - ë©”ëª¨ë¦¬ í• ë‹¹ ì—†ì´ ìƒì„±ìë§Œ í˜¸ì¶œ
void* operator new(size_t, void* ptr) noexcept { return ptr; }
```

**SharedHeapAllocator (#12)**

í•œ ë²ˆë§Œ ìƒì„±ë˜ëŠ” ê°ì²´ìš© (ë””ë°”ì´ìŠ¤ë‹¹ 1ê°œ ë“±):

```cpp
// BlockAllocator: 256ê°œ í’€ë§ â†’ 1ê°œë§Œ ì‚¬ìš©í•˜ë©´ ë‚­ë¹„
// HeapAllocator: ê°œë³„ í™ í• ë‹¹ (í’€ë§ ì—†ìŒ)

auto handler = make_shared_single<AllocationHandler>();
```

**self-assign ì²´í¬ (#13)**

```cpp
Allocation& operator=(const Allocation& other) {
    if (&other == this) return *this;  // ìê¸° í• ë‹¹ ë°©ì§€
    // ...
}
```

**CommandList BlockAllocator (#22)**

shared_ptr ì™¸ì—ë„ CommandList í’€ë§ì— ì ìš©:

```cpp
// ë³€ê²½ ì „
std::vector<std::unique_ptr<CommandList_DX12>> commandlists;

// ë³€ê²½ í›„
BlockAllocator<CommandList_DX12, 64> cmd_allocator;
std::vector<CommandList_DX12*> commandlists;
```

---

## VizMotive íŠ¹ìˆ˜ ì‚¬í•­: DLL ê²½ê³„ ë¬¸ì œ

### WickedEngine ë°©ì‹ì˜ ë¬¸ì œ

```
WickedEngine: ë‹¨ì¼ ì‹¤í–‰íŒŒì¼ (exe)
â†’ inline ë³€ìˆ˜ê°€ í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ë§Œ ì¡´ì¬
â†’ handle ì¸ì½”ë”© ë°©ì‹ (8ë°”ì´íŠ¸) ì‘ë™

VizMotive: ë‹¤ì¤‘ DLL ì•„í‚¤í…ì²˜
â†’ Engine.dll + DX12.dll ê°ê° ë³„ë„ inline ì¸ìŠ¤í„´ìŠ¤
â†’ DX12.dllì—ì„œ ë“±ë¡í•œ allocatorë¥¼ Engine.dllì—ì„œ ëª» ì°¾ìŒ!
```

### VizMotive í•´ê²°ì±…

```cpp
// WickedEngine: handle ì¸ì½”ë”© (8ë°”ì´íŠ¸)
struct shared_ptr {
    uint64_t handle;  // ptr | allocator_id
};

// VizMotive: í¬ì¸í„° ì§ì ‘ ì €ì¥ (16ë°”ì´íŠ¸)
struct shared_ptr {
    T* ptr;
    SharedBlockAllocator* allocator;  // ì§ì ‘ ì €ì¥!
};
```

| | WickedEngine | VizMotive |
|---|---|---|
| shared_ptr í¬ê¸° | 8ë°”ì´íŠ¸ | 16ë°”ì´íŠ¸ |
| DLL ê²½ê³„ | âŒ ë¬¸ì œ | âœ… ì •ìƒ |
| êµ¬í˜„ ë³µì¡ë„ | ë†’ìŒ | ë‚®ìŒ |

---

## ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Pooled shared_ptr ì „ì²´ êµ¬ì¡°                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ SharedBlockAllocatorImpl<Texture_DX12>                  â”‚    â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚
â”‚  â”‚ Block 0:                                                â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚ â”‚ RawStruct[0]     â”‚ RawStruct[1]     â”‚ ... â”‚ (free) â”‚  â”‚    â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚        â”‚  â”‚    â”‚
â”‚  â”‚ â”‚ â”‚ Texture_DX12 â”‚ â”‚ â”‚ Texture_DX12 â”‚ â”‚     â”‚        â”‚  â”‚    â”‚
â”‚  â”‚ â”‚ â”‚ refcount=2   â”‚ â”‚ â”‚ refcount=1   â”‚ â”‚     â”‚        â”‚  â”‚    â”‚
â”‚  â”‚ â”‚ â”‚ weak_cnt=1   â”‚ â”‚ â”‚ weak_cnt=0   â”‚ â”‚     â”‚        â”‚  â”‚    â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚        â”‚  â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ free_list: [&RawStruct[255], &RawStruct[254], ...]      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â†‘                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Texture tex;                                            â”‚    â”‚
â”‚  â”‚ tex.internal_state = make_shared<Texture_DX12>();       â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚    â”‚
â”‚  â”‚ â”‚ shared_ptr<void>               â”‚                      â”‚    â”‚
â”‚  â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                      â”‚    â”‚
â”‚  â”‚ â”‚ ptr = &RawStruct[0].data       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚ â”‚ allocator = SharedBlockAlloc*  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”˜    â”‚
â”‚                                                         â–¼       â”‚
â”‚                                 refcount ê´€ë¦¬:                   â”‚
â”‚                                 - inc_refcount()                â”‚
â”‚                                 - dec_refcount()                â”‚
â”‚                                 - try_inc_refcount() (CAS)      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## êµí›ˆ

### 1. ë©”ëª¨ë¦¬ í’€ë§
ë¹ˆë²ˆí•˜ê²Œ ìƒì„±/ì‚­ì œë˜ëŠ” ê°ì²´ëŠ” í™ í• ë‹¹ ëŒ€ì‹  í’€ë§ ì‚¬ìš©.
Block Allocatorë¡œ ê°™ì€ íƒ€ì…ì„ ì—°ì† ë©”ëª¨ë¦¬ì— ë°°ì¹˜í•˜ë©´ ìºì‹œ íš¨ìœ¨ + í• ë‹¹ ì„±ëŠ¥ í–¥ìƒ.

### 2. weak_ptr::lock() ì˜¬ë°”ë¥¸ êµ¬í˜„
- `incâ†’checkâ†’dec` íŒ¨í„´ì€ race condition ìœ ë°œ
- `try_inc_refcount()`ë¡œ ì›ìì  ì¡°ê±´ë¶€ ì¦ê°€ í•„ìš”
- CAS (Compare-And-Swap)ê°€ í•µì‹¬

### 3. DLL ê²½ê³„ ì£¼ì˜
`inline` ë³€ìˆ˜ëŠ” DLLë§ˆë‹¤ ë³„ë„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ë¨.
DLL ê²½ê³„ë¥¼ ë„˜ëŠ” ë°ì´í„°ëŠ” ID ëŒ€ì‹  ì§ì ‘ í¬ì¸í„° ì €ì¥ ê³ ë ¤.

### 4. ì»¤ë°‹ ì˜ì¡´ì„±
ì´ ì£¼ì œì˜ ì»¤ë°‹ë“¤ì€ ì„œë¡œ ì˜ì¡´ì„±ì´ ë†’ìŒ:
- #9 â†’ #10 (ê¸°ë³¸ê°’ ìˆ˜ì •)
- #9 â†’ #19 (ì™„ì „í•œ í•´ê²°)
- #7 â†’ #11 (placement new í—ˆìš©)

---

## VizMotive ì ìš©

ëª¨ë“  ì»¤ë°‹ ì ìš© ì™„ë£Œ:
- `Allocator.h`: SharedBlockAllocator, shared_ptr, weak_ptr, make_shared
- `GBackend.h`: internal_state íƒ€ì… ë³€ê²½
- `GraphicsDevice_DX12.cpp`: make_shared í˜¸ì¶œ ë³€ê²½
- DLL ê²½ê³„ ëŒ€ì‘: í¬ì¸í„° ì§ì ‘ ì €ì¥ ë°©ì‹ (16ë°”ì´íŠ¸)
